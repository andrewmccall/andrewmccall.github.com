
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Restrict access in Puppet – part 2 - andrewmccall.com</title>
  <meta name="author" content="Andrew McCall">

  
  <meta name="description" content="Yesterday we got the key creation working, today we&#8217;ll lock the server down properly by preventing root login and adding a user to the sudoers &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://andrewmccall.com/blog/2010/08/11/restrict-access-in-puppet-part-2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="andrewmccall.com" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">andrewmccall.com</a></h1>
  
    <h2>My stie</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:andrewmccall.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Restrict Access in Puppet – Part 2</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-08-11T00:00:00+01:00" pubdate data-updated="true">Aug 11<span>th</span>, 2010</time>
        
      </p>
    
  </header>


<div class="entry-content">Yesterday we got the key creation working, today we&#8217;ll lock the server down properly by preventing root login and adding a user to the sudoers file. 

Let&#8217;s start with the latter. 

<h2>Sudoers</h2>

First we need a group of administrators, for the sake of ease and self-documentation I called it sudo. Well ubuntu called it sudo, but we still need to ensure it exists, because it won&#8217;t on all operating systems.

<em><div class="CodeRay">
  <div class="code"><pre>modules/sudo/manifests/init.pp</pre></div>
</div>
</em>
<div class="CodeRay">
  <div class="code"><pre>import &quot;*&quot;
class sudo {
    include sudo::install, sudo::sudoers
    group{&quot;sudo&quot;: ensure =&gt; &quot;present&quot;}
}</pre></div>
</div>


All we did here was very simply ensure that the puppet group existed. Next we need to update our sudoers file to allow members of the sudo group to sudo. 
<em><div class="CodeRay">
  <div class="code"><pre>modules/sudo/files/sudoers</pre></div>
</div>
</em>
<div class="CodeRay">
  <div class="code"><pre># /etc/sudoers
#
# This file MUST be edited with the 'visudo' command as root.
#
# See the man page for details on how to write a sudoers file.
#

Defaults        env_reset

# Uncomment to allow members of group sudo to not need a password
# %sudo ALL=NOPASSWD: ALL

# Host alias specification

# User alias specification

# Cmnd alias specification

# User privilege specification
root        ALL=(ALL) ALL
%sudo   ALL=(ALL) ALL</pre></div>
</div>


All we did here was add the last line which allows members of the sudo group to do everything. We do require a user&#8217;s password. 

The next and final step is to ensure our user module allows us to specify additional groups. 

<em><div class="CodeRay">
  <div class="code"><pre>modules/user/manifests/init.pp</pre></div>
</div>
</em>
<div class="CodeRay">
  <div class="code"><pre>import &quot;*&quot;
class user {

    define create ($groups = &quot;&quot;) {
        group{$title: ensure =&gt; &quot;present&quot;}         
        user { &quot;$title&quot;:
            ensure  =&gt; &quot;present&quot;,
            gid   =&gt; &quot;$title&quot;,
            groups =&gt; $groups,
            home    =&gt; &quot;/home/$title&quot;,
            shell   =&gt; &quot;/bin/bash&quot;,
            managehome =&gt; true,
            require =&gt; [Group[&quot;$title&quot;]],
        }
        file { &quot;/home/$title&quot;:
            ensure =&gt; &quot;directory&quot;,
            mode   =&gt; 700,
            owner  =&gt; &quot;$title&quot;,
            group  =&gt; &quot;$title&quot;,
        }
        file { &quot;/home/$title/.ssh&quot;:
            ensure =&gt; &quot;directory&quot;,
            mode   =&gt; 600,
            owner  =&gt; &quot;$title&quot;,
            group  =&gt; &quot;$title&quot;,
        }
        ssh::auth::key{&quot;$title&quot;:}
    }
    define client_key ($ensure = &quot;&quot;, $filename = &quot;&quot;) {
        ssh::auth::client{&quot;$title&quot;: ensure=&gt;$ensure, filename=&gt;$filename}
    }
    define server_key ($ensure = &quot;&quot;, $user = &quot;&quot;) {
        ssh::auth::server{&quot;$title&quot;: ensure=&gt;$ensure, user=&gt;$user}
    }
}</pre></div>
</div>


On line 4 I added  a parameter $groups which defaults to empty and on line 9 I pass that parameter into the user creation step. 

There you have it, run puppet and your user will get added to the sudo group and should be able to <a href="http://xkcd.com/149/">sudo themselves up a sandwich</a>.

<h2>sshd</h2>

The next step in securing our server is to prevent logins with passwords and prevent root logins. 

<em>I can&#8217;t stress enough how important it is here that you test you can login with your key and that you can sudo or at least you know your root password. If you go ahead without being able to do these things you may be left unable to login to your machine.</em>

Our sshd module is a lot like the original sudoers module. We&#8217;re simply copying a file into /etc. 

Start by creating our module directories

<div class="CodeRay">
  <div class="code"><pre># mkdir -p modules/sshd/files modules/sshd/manifests</pre></div>
</div>


Next we create the init.pp file for the ssh module. I&#8217;ve taken inspiration from the <a href="http://projects.puppetlabs.com/projects/1/wiki/Puppet_Common_Modules_Ssh">example on the puppet wiki</a> 

<em><div class="CodeRay">
  <div class="code"><pre>modules/sshd/manifests/init.pp</pre></div>
</div>
</em>
<div class="CodeRay">
  <div class="code"><pre>class sshd {

   package {&quot;openssh-server&quot;: ensure=&gt; &quot;installed&quot;}

    file { &quot;/etc/ssh/sshd_config&quot;:
        owner =&gt; &quot;root&quot;,
        mode =&gt; 644,
        notify =&gt; Service[&quot;ssh&quot;],
        require =&gt; Package[&quot;openssh-server&quot;],
        source =&gt; 
            &quot;puppet:///modules/sshd/sshd_config&quot;
    }

    service { &quot;ssh&quot;:
        enable =&gt; true,
        ensure =&gt; running,
        require =&gt; [
            File[&quot;/etc/ssh/sshd_config&quot;],
            Package[&quot;openssh-server&quot;]
        ]
    }
}</pre></div>
</div>


Next copy your current sshd_config into the files directory of your module

<div class="CodeRay">
  <div class="code"><pre># cp /etc/ssh/sshd_config modules/sshd/files</pre></div>
</div>


Then I edited the following lines to deny root logins and password authentication:

<em><div class="CodeRay">
  <div class="code"><pre>modules/sshd/files/sshd_config</pre></div>
</div>
</em>
<div class="CodeRay">
  <div class="code"><pre>PermitRootLogin no
...
PasswordAuthentication no</pre></div>
</div>


Finally I updated my node.pp to include the new module

<em><div class="CodeRay">
  <div class="code"><pre>manifests/nodes.pp</pre></div>
</div>
</em>
<div class="CodeRay">
  <div class="code"><pre>node build {
    include sudo, user, sshd, ssh::auth, user::keystore
    user::create{&quot;andrewmccall&quot;: groups =&gt; &quot;sudo&quot;}
    user::client_key{&quot;andrewmccall&quot;:}
    user::server_key{&quot;andrewmccall&quot;:}
}</pre></div>
</div>


Execute puppet and your sshd_config should now be properly set.
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Andrew McCall</span></span>

      








  


<time datetime="2010-08-11T00:00:00+01:00" pubdate data-updated="true">Aug 11<span>th</span>, 2010</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://andrewmccall.com/blog/2010/08/11/restrict-access-in-puppet-part-2/" data-via="andrewmccall" data-counturl="http://andrewmccall.com/blog/2010/08/11/restrict-access-in-puppet-part-2/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2010/08/10/restrict-access-in-puppet-part-1/" title="Previous Post: Restrict access in Puppet - part 1">&laquo; Restrict access in Puppet - part 1</a>
      
      
        <a class="basic-alignment right" href="/blog/2010/08/17/multiple-users-same-key-in-puppet-/" title="Next Post: Multiple users, same key in puppet. ">Multiple users, same key in puppet.  &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/02/24/octopress/">Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/11/customer-support-what-a-joke-/">Customer support, what a joke.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/12/23/validation-1-0-0-released-/">Validation 1.0.0 released.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/12/16/oembed/">oEmbed</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/12/15/even-more-secure-passwords-/">Even more secure passwords.</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/andrewmccall">@andrewmccall</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'andrewmccall',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("andrewmccall", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/andrewmccall" class="twitter-follow-button" data-show-count="false">Follow @andrewmccall</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Andrew McCall -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
